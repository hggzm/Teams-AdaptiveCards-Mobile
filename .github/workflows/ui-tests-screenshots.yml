name: UI Tests with Screenshots

on:
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'source/ios/**'
      - 'samples/**'
      - '.github/workflows/ui-tests-screenshots.yml'
      - 'scripts/test-utils/**'
  
  push:
    branches: [ main, master ]
    paths:
      - 'source/ios/**'
  
  workflow_dispatch:
    inputs:
      test_name:
        description: 'Specific test to run (leave empty for all tests)'
        required: false
        default: ''

jobs:
  ui-tests:
    name: Run UI Tests with Screenshots
    runs-on: macos-14
    
    strategy:
      fail-fast: false
      matrix:
        test-mode: [visualizer]
    
    timeout-minutes: 60
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Show Environment Info
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "  üîß Environment Information"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "macOS Version:"
          sw_vers
          echo ""
          echo "Xcode Version:"
          xcodebuild -version
          echo ""
          echo "Available Simulators:"
          xcrun simctl list devices available | grep "iPhone"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
      
      - name: Install CocoaPods Dependencies
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "  üì¶ Installing CocoaPods Dependencies"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          cd source/ios/AdaptiveCards
          pod install --verbose
          echo "‚úÖ CocoaPods dependencies installed"

      - name: Setup Simulator
        id: simulator
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "  üöÄ Booting iPhone 16 simulator..."
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          
          # Find iPhone 16 simulator
          SIMULATOR_ID=$(xcrun simctl list devices | grep "iPhone 16 (" | grep -v "Pro" | grep -v "Plus" | head -1 | grep -oE '\([A-F0-9\-]+\)' | tr -d '()')
          
          if [ -z "$SIMULATOR_ID" ]; then
            echo "‚ùå iPhone 16 simulator not found"
            exit 1
          fi
          
          echo "Using simulator: $SIMULATOR_ID"
          
          # Boot the simulator
          xcrun simctl boot "$SIMULATOR_ID" || true
          
          # Wait for simulator to be ready
          echo "Waiting for simulator to fully boot..."
          xcrun simctl bootstatus "$SIMULATOR_ID" -b
          
          echo "‚úÖ Simulator ready"
      
      - name: Run UI Tests with Screenshots
        id: ui-tests
        continue-on-error: true
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "  üì± Running UI Tests with Screenshot Capture"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          
          # Make script executable
          chmod +x ./scripts/test-utils/run_adaptive_cards_tests_with_screenshots.sh
          
          if [ -n "${{ github.event.inputs.test_name }}" ]; then
            echo "Running specific test: ${{ github.event.inputs.test_name }}"
            bash ./scripts/test-utils/run_adaptive_cards_tests_with_screenshots.sh ${{ matrix.test-mode }} "${{ github.event.inputs.test_name }}"
          else
            echo "Running all UI tests"
            bash ./scripts/test-utils/run_adaptive_cards_tests_with_screenshots.sh ${{ matrix.test-mode }}
          fi
        timeout-minutes: 45
        env:
          FASTLANE_SKIP_UPDATE_CHECK: true
          FASTLANE_DISABLE_COLORS: true
      
      - name: Collect Test Results
        if: always()
        id: test-results
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "  üìä Collecting Test Results"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          
          # Find latest screenshot directory
          LATEST_DIR=$(ls -td screenshots/*/ 2>/dev/null | head -1)
          
          if [ -z "$LATEST_DIR" ]; then
            echo "‚ö†Ô∏è No screenshot directory found"
            echo "test_status=unknown" >> $GITHUB_OUTPUT
            echo "screenshot_count=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Screenshot directory: $LATEST_DIR"
          
          # Count screenshots
          XCTEST_COUNT=$(ls "$LATEST_DIR"visualizer/xctest_*.png 2>/dev/null | wc -l | xargs)
          AUTO_COUNT=$(ls "$LATEST_DIR"visualizer/auto_*.png 2>/dev/null | wc -l | xargs)
          TOTAL_COUNT=$((XCTEST_COUNT + AUTO_COUNT))
          
          echo "XCTest screenshots: $XCTEST_COUNT"
          echo "Auto screenshots: $AUTO_COUNT"
          echo "Total screenshots: $TOTAL_COUNT"
          
          # Determine test status
          if [ "${{ steps.ui-tests.outcome }}" == "success" ]; then
            TEST_STATUS="‚úÖ Passed"
            echo "test_status=passed" >> $GITHUB_OUTPUT
          else
            TEST_STATUS="‚ùå Failed"
            echo "test_status=failed" >> $GITHUB_OUTPUT
          fi
          
          echo "screenshot_count=$TOTAL_COUNT" >> $GITHUB_OUTPUT
          echo "xctest_count=$XCTEST_COUNT" >> $GITHUB_OUTPUT
          echo "auto_count=$AUTO_COUNT" >> $GITHUB_OUTPUT
          echo "screenshot_dir=$(basename $LATEST_DIR)" >> $GITHUB_OUTPUT
          
          # Create summary
          echo "## üì± UI Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** $TEST_STATUS" >> $GITHUB_STEP_SUMMARY
          echo "**Test Mode:** ${{ matrix.test-mode }}" >> $GITHUB_STEP_SUMMARY
          echo "**Total Screenshots:** $TOTAL_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "  - XCTest Screenshots: $XCTEST_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "  - Auto Screenshots: $AUTO_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üì¶ Download artifacts to view screenshots" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload XCTest Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: xctest-screenshots-${{ matrix.test-mode }}-${{ github.run_number }}
          path: screenshots/**/visualizer/xctest_*.png
          if-no-files-found: warn
          retention-days: 30
          compression-level: 6
      
      - name: Upload Auto Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: auto-screenshots-${{ matrix.test-mode }}-${{ github.run_number }}
          path: screenshots/**/visualizer/auto_*.png
          if-no-files-found: warn
          retention-days: 30
          compression-level: 6
      
      - name: Upload All Screenshots (Combined)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: all-screenshots-${{ matrix.test-mode }}-${{ github.run_number }}
          path: |
            screenshots/**/visualizer/*.png
            !screenshots/**/TestResults.xcresult/**
          if-no-files-found: warn
          retention-days: 30
          compression-level: 6
      
      - name: Upload Test Results Bundle
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-bundle-${{ matrix.test-mode }}-${{ github.run_number }}
          path: screenshots/**/TestResults.xcresult
          if-no-files-found: warn
          retention-days: 14
      
      - name: Comment on PR
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const testStatus = '${{ steps.test-results.outputs.test_status }}';
            const screenshotCount = '${{ steps.test-results.outputs.screenshot_count }}';
            const xctestCount = '${{ steps.test-results.outputs.xctest_count }}';
            const autoCount = '${{ steps.test-results.outputs.auto_count }}';
            const testMode = '${{ matrix.test-mode }}';
            const runNumber = '${{ github.run_number }}';
            const runId = '${{ github.run_id }}';
            
            const statusEmoji = testStatus === 'passed' ? '‚úÖ' : '‚ùå';
            const statusText = testStatus === 'passed' ? '**PASSED**' : '**FAILED**';
            
            const comment = `## ${statusEmoji} UI Test Results - ${statusText}
            
            ### üì± Test Information
            - **Mode:** \`${testMode}\`
            - **Status:** ${statusText}
            - **Total Screenshots:** ${screenshotCount}
              - XCTest Screenshots: ${xctestCount}
              - Auto Screenshots: ${autoCount}
            
            ### üì∏ View Screenshots
            
            Download the artifacts from the workflow run to view captured screenshots:
            
            | Artifact | Description |
            |----------|-------------|
            | \`xctest-screenshots-${testMode}-${runNumber}\` | Screenshots captured within test code |
            | \`auto-screenshots-${testMode}-${runNumber}\` | Automated periodic screenshots |
            | \`all-screenshots-${testMode}-${runNumber}\` | All screenshots combined |
            | \`test-results-bundle-${testMode}-${runNumber}\` | Complete XCTest result bundle |
            
            ### üîó Links
            
            [üìä View Workflow Run](${context.payload.repository.html_url}/actions/runs/${runId})
            
            ---
            <details>
            <summary>üí° How to use screenshots</summary>
            
            1. Go to the [workflow run](${context.payload.repository.html_url}/actions/runs/${runId})
            2. Scroll to the **Artifacts** section at the bottom
            3. Download the desired artifact
            4. Extract and view the PNG files
            
            **XCTest screenshots** (\`xctest_*.png\`) show specific UI states captured during test execution.
            **Auto screenshots** (\`auto_*.png\`) are captured periodically during test execution.
            
            </details>
            `;
            
            try {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (error) {
              console.log('Failed to create comment:', error);
            }
      
      - name: Check Test Status
        if: steps.ui-tests.outcome == 'failure'
        run: |
          echo "‚ùå UI tests failed"
          exit 1

  summary:
    name: Test Summary
    needs: ui-tests
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          echo "## üéâ UI Tests Workflow Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All test jobs have finished. Check individual job results above." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì¶ Artifacts Available" >> $GITHUB_STEP_SUMMARY
          echo "- XCTest screenshots (captured in test code)" >> $GITHUB_STEP_SUMMARY
          echo "- Auto screenshots (periodic captures)" >> $GITHUB_STEP_SUMMARY
          echo "- Complete test result bundles" >> $GITHUB_STEP_SUMMARY
